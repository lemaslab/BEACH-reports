---
title: "anaylzeCurrent_Particpant"
author: "Yasmine Gillespie"
date: '2022-10-23'
output: html_document
---

```{r, include=FALSE}
##-------------- 
# **************************************************************************** #
# ***************                Project Overview              *************** #
# **************************************************************************** #

# Author:      Yasmine Gillespie
# Date:        November 17, 2020 
# Modify:      November 6, 2022
# IRB:         The Breastfeeding and EArly Child Health Study
# IRB:         IRB201601899

# version: R version 4.0.2 (2020-06-22)
# version: Rstudio version Version 1.3.959 

# **************************************************************************** #
# ***************                Description                   *************** #
# **************************************************************************** #

# PLAN: Access redcap via API and pull/format/clean data for downstream analysis.
# Note: vpn must be active

# Next steps
#- function to call the IDs and events
#- function to batch pull EHR data by year/event and combine into final dataset. 


```

```{r, message=FALSE,warning=FALSE, echo = FALSE}

# **************************************************************************** #
# ***************                Library                       *************** #
# **************************************************************************** #

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(dplyr)
library(flextable)
library(gt)
library(formattable)
library(gtsummary)
library(ggplot2)
library(ggrepel)
library(keyringr)
library(readxl)
library(redcapAPI)
library(REDCapR)
library(vtree)
library(vistime)
library(labelled)
library(plyr)
library(plotly)
library(tidyquant)
library(readr)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
load("~/BEACH-Reports/output/reports/recruitment/Current_Particpant_raw.RData")
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
CP_raw <- CP_raw[ -c(2:4) ]

```

```{r, message=FALSE,warning=FALSE, echo = FALSE}

names(CP_raw)[2] <- "Random_Contact"
names(CP_raw)[3] <- "Prescreen_Survey"
names(CP_raw)[4] <- "Phone_Screen"
names(CP_raw)[5] <- "IDR"
names(CP_raw)[6] <- "Consent"
names(CP_raw)[7] <- "Complete"
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
#renaming
CP_raw=CP_raw %>%
  mutate(beachphone_hear_about_us=recode(beachphone_hear_about_us,
                              "1"="Flyer",
                              "2"="Radio",
                              "3"="Social Media",
                              "4"="Newspaper",
                              "5"="Word-of-mouth",
                              "6"="Other"
                               ))
                              
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
Eligible_Pass= filter(CP_raw, beachphone_pass_fail == 1)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
Eligible_Pass$BMI = coalesce(Eligible_Pass$beach_final_bmi, Eligible_Pass$beachphone_prepreg_bmi)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
#renaming
Eligible_Pass=Eligible_Pass %>%
  mutate(bmi_analysis_prepregnant=recode(bmi_analysis_prepregnant,
                              "1"="Normal",
                              "2"="Overweight",
                              "3"= "Obese"
                               ))
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
Eligible_Pass_age_bmi=Eligible_Pass %>%
  select(test_id,
         beachphone_age,
         BMI,
       bmi_analysis_prepregnant,
       beachphone_hear_about_us
       )%>%
  
   mutate( age_groups =  beachphone_age) %>%
   mutate(Age_grouping = case_when((age_groups <= 25) ~ "18-25",
                                  (age_groups >25 & age_groups <= 30) ~ "26-30",
                                 (age_groups >30 & age_groups <= 35) ~ "31-35",
                                 (age_groups >35 & age_groups <= 40) ~ "36-40",
                                  (age_groups > 40) ~ "> 40"))%>%
   mutate(prepreg_bmi = BMI)%>%
   mutate(Bmi_grouping = case_when((prepreg_bmi >29) ~ "Obese",
                                  (prepreg_bmi >26 & prepreg_bmi<29) ~ "Overweight",
                                  (prepreg_bmi <26) ~ "Normal"))%>%
  select(test_id,age_groups, Age_grouping,prepreg_bmi,Bmi_grouping, bmi_analysis_prepregnant, beachphone_hear_about_us)

```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
Eligible_Pass_age_bmi$BMI_Type = coalesce(Eligible_Pass_age_bmi$Bmi_grouping, Eligible_Pass_age_bmi$bmi_analysis_prepregnant)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
Eligible_Pass_age_bmi_clean <- Eligible_Pass_age_bmi[ -c(2,4,5,6) ]
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}

names(Eligible_Pass_age_bmi_clean)[4] <- "BMI_grouping"

```

```{r, message=FALSE,warning=FALSE, echo = FALSE}

vtree(Eligible_Pass, "beachphone_hear_about_us Phone_Screen", palette = 3, sortfill = TRUE, horiz=FALSE)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}

vtree(Eligible_Pass_age_bmi_clean, "beachphone_hear_about_us Age_grouping", palette = 3, sortfill = TRUE, horiz=FALSE)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
vtree(CP.age.bmi_clean, "beachphone_hear_about_us BMI_grouping", palette = 3, sortfill = TRUE, horiz=FALSE)
```




```{r, message=FALSE,warning=FALSE, echo = FALSE}
CP_Consent= filter(CP_raw, Consent == 1)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
CP_Consent$BMI = coalesce(CP_Consent$beach_final_bmi, CP_Consent$beachphone_prepreg_bmi)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
#renaming
CP_Consent=CP_Consent %>%
  mutate(bmi_analysis_prepregnant=recode(bmi_analysis_prepregnant,
                              "1"="Normal",
                              "2"="Overweight",
                              "3"= "Obese"
                               ))
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
CP.age.bmi=CP_Consent %>%
  select(test_id,
         beachphone_age,
         BMI,
       bmi_analysis_prepregnant,
       beachphone_hear_about_us
       )%>%
  
   mutate( age_groups =  beachphone_age) %>%
   mutate(Age_grouping = case_when((age_groups <= 25) ~ "18-25",
                                  (age_groups >25 & age_groups <= 30) ~ "26-30",
                                 (age_groups >30 & age_groups <= 35) ~ "31-35",
                                 (age_groups >35 & age_groups <= 40) ~ "36-40",
                                  (age_groups > 40) ~ "> 40"))%>%
   mutate(prepreg_bmi = BMI)%>%
   mutate(Bmi_grouping = case_when((prepreg_bmi >29) ~ "Obese",
                                  (prepreg_bmi >26 & prepreg_bmi<29) ~ "Overweight",
                                  (prepreg_bmi <26) ~ "Normal"))%>%
  select(test_id,age_groups, Age_grouping,prepreg_bmi,Bmi_grouping, bmi_analysis_prepregnant, beachphone_hear_about_us)

```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
CP.age.bmi$BMI_Type = coalesce(CP.age.bmi$Bmi_grouping, CP.age.bmi$bmi_analysis_prepregnant)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
CP.age.bmi_clean <- CP.age.bmi[ -c(2,4,5,6) ]
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}

names(CP.age.bmi_clean)[4] <- "BMI_grouping"

```

```{r, message=FALSE,warning=FALSE, echo = FALSE}

vtree(CP_Consent, "beachphone_hear_about_us Phone_Screen", palette = 3, sortfill = TRUE, horiz=FALSE)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}

vtree(CP.age.bmi_clean, "beachphone_hear_about_us Age_grouping", palette = 3, sortfill = TRUE, horiz=FALSE)
```

```{r, message=FALSE,warning=FALSE, echo = FALSE}
vtree(CP.age.bmi_clean, "beachphone_hear_about_us BMI_grouping", palette = 3, sortfill = TRUE, horiz=FALSE)
```







