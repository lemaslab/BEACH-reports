---
title: "Get RedCap Data: Problems During Pregnancy"
author: "Dominick J. Lemas, Michele Himadi"
date: "08/31/2023"
output: html_document
pandoc_args: ["--wrap=preserve"]

---

```{r, include=FALSE}
##-------------- 
# **************************************************************************** #
# ***************                Project Overview              *************** #
# **************************************************************************** #

# Author:            Dominick J. Lemas, Michele Himadi
# Start Date:        08/31/2023 
# Date Modify:       
# Project:           The Breastfeeding and EArly Child Health Study
# IRB:               IRB201601034
#                   
#
# version: R version 4.0.2 (2020-06-22)
# version: Rstudio version Version 1.3.959 

# **************************************************************************** #
# ***************                Description                   *************** #
# **************************************************************************** #

# PLAN: Access redcap via API and pull/format/clean data for downstream analysis.
# Note: vpn must be active

# keyringr must be installed: https://cran.r-project.org/web/packages/keyringr/vignettes/Avoiding_plain_text_passwords_in_R_with_keyringr.html

project_name="The Breastfeeding and EArly Child Health Study"
irb_number="IRB201601034"

```

```{r, message=FALSE, include=FALSE}

# **************************************************************************** #
# ***************                Library                       *************** #
# **************************************************************************** #

library(keyringr)
library(redcapAPI)
library(REDCapR)
library(tidyverse)
# library(ezknitr)
source("~/BEACH-reports/code/utils/utils.R")
library(dplyr)
library(tidyr)
library(gtsummary)

```

```{r, message=FALSE,include=FALSE}

# **************************************************************************** #
# ***************              Extract Data                    *************** #
# **************************************************************************** #

# API & URL
#----------
uri <- "https://redcap.ctsi.ufl.edu/redcap/api/"
api_token=get_API_token("beach_api")

# REPORT IDS
#-----------

# Study Overview
report_id<-37206L
report_name= "Problems During Pregnancy"


# PULL DATA
#-----------
report_raw <-
  REDCapR::redcap_report(
    redcap_uri = uri,
    token      = api_token,
    report_id  = report_id
  )$data 

report = report_raw %>%
  select(-redcap_repeat_instrument,-redcap_repeat_instance, -redcap_survey_identifier, -health_update_3rd_trimester_v5082518_timestamp, -redcap_event_name,
         -mom2wk_abx_name, -inf2wk_meds_name, -inf2wk_abx_name, -mom2wk_meds_name, -mom3t_meds_name, -mom2mo_meds_name, -mom2mo_abx_name, -inf2mo_meds_name, -inf2mo_abx_name)   # drop out variables not needed #last two lines are medicines

df <- report %>%
  group_by(test_id) %>%
  fill(everything(), .direction = "downup") %>%
  slice(1)
df <- as.data.frame(df)

df$maternal_study_groups[df$maternal_study_groups == "1"] <- "NW"
df$maternal_study_groups[df$maternal_study_groups == "2"] <- "OW"
df$maternal_study_groups[df$maternal_study_groups == "3"] <- "OB"

df$mom2wk_infant_hosp_stay[df$mom2wk_infant_hosp_stay == "1"] <- "<1"
df$mom2wk_infant_hosp_stay[df$mom2wk_infant_hosp_stay == "2"] <- "1-2"
df$mom2wk_infant_hosp_stay[df$mom2wk_infant_hosp_stay == "3"] <- "3-5"
df$mom2wk_infant_hosp_stay[df$mom2wk_infant_hosp_stay == "4"] <- "6-14"
df$mom2wk_infant_hosp_stay[df$mom2wk_infant_hosp_stay == "5"] <- ">14"
df$mom2wk_infant_hosp_stay[df$mom2wk_infant_hosp_stay == "6"] <- "still in hospital"
df$mom2wk_infant_hosp_stay[df$mom2wk_infant_hosp_stay == "7"] <- "not born in hospital"

df$mom2wk_infant_nicu[df$mom2wk_infant_nicu == "0"] <- "no"
df$mom2wk_infant_nicu[df$mom2wk_infant_nicu == "1"] <- "yes"

df[df == "1"] <- "yes"
df[df == "2"] <- "no"

df_problems <- df %>%
  select(-overview_gest_age, -beach_final_bmi, -maternal_study_groups, -mom2wk_infant_hosp_stay, -mom2wk_infant_nicu, -test_id,)

df_outcomes <- df %>% 
  select(overview_gest_age, beach_final_bmi, maternal_study_groups, mom2wk_infant_hosp_stay, mom2wk_infant_nicu)

```

```{r, message=FALSE,include=FALSE}

# **************************************************************************** #
# ***************              Save Data Local                 *************** #
# **************************************************************************** #

# Save the data in your local laptop (Github path: /data)
save(list=c("df"),file="~/BEACH-reports/data/raw/report_37206.RData")

output_directory="~/BEACH-reports/data/raw/"
output_file_name="report_37206.RData"

```

#### __Project Details__
Title: `r project_name`  
IRB Number: `r irb_number`  
Redcap URL: `r uri`  
Report Name: `r report_name`  
Report ID: `r report_id`

#### __Data Processing Summary__
Variables of interest are stored as RedCap reports. Data is extracted from REdcap via REDCapR using URL and API token. The extracted data is lightly formatted and output as an *.rda object for downstream analysis.  
![](redcap_workflow.png)

### __Problems Summary__
```{r, echo=FALSE, message=FALSE}
df_problems_trimmed <- df_problems %>% select(-mom3t_cervix, -mom3t_water_broke, -mom3t_blood_trans, -mom2wk_cervix, -mom2wk_car_accident) #taking out problems with 0 occurrences

names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_prenat_vagbleed"] <- '3rd Trimester Vaginal Bleeding'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_uti"] <- '3rd Trimester UTI'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_nausea"] <- '3rd Trimester Severe Nausea'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_cervix"] <- '3rd Trimester Cervix Sewn Shut'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_high_bp2"] <- '3rd Trimester Hypertension'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_placenta"] <- '3rd Trimester Placenta Issues'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_labor_pains"] <- '3rd Trimester Early Labor Pains'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_water_broke"] <- '3rd Trimester Water Broke Early'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_blood_trans"] <- '3rd Trimester Blood Transfusion'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom3t_car_accident"] <- '3rd Trimester Car Accident'

names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_vagbleed"] <- '2 Week Vaginal Bleeding'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_uti"] <- '2 Week UTI'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_nausea"] <- '2 Week Severe Nausea'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_cervix"] <- '2 Week Cervix Sewn Shut'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_high_bp"] <- '2 Week Hypertension'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_placenta"] <- '2 Week Placenta Issues'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_labor_pains"] <- '2 Week Early Labor Pains'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_water_broke"] <- '2 Week Water Broke Early'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_blood_trans"] <- '2 Week Blood Transfusion'
names(df_problems_trimmed)[names(df_problems_trimmed) == "mom2wk_car_accident"] <- '2 Week Car Accident'


tbl_summary(df_problems_trimmed,missing="no")


```

### __Outcomes Summary__
```{r, echo=FALSE, message=FALSE}
df_outcomes = df_outcomes %>% select(-beach_final_bmi)
names(df_outcomes)[names(df_outcomes) == "overview_gest_age"] <- 'Gestational Age'
names(df_outcomes)[names(df_outcomes) == "mom2wk_infant_hosp_stay"] <- 'Length of hospital stay for infant'
names(df_outcomes)[names(df_outcomes) == "mom2wk_infant_nicu"] <- 'Infants admitted to NICU'

df_outcomes[df_outcomes == "NW"] <- "Normal Weight"
df_outcomes[df_outcomes == "OW"] <- "Overweight"
df_outcomes[df_outcomes == "OB"] <- "Obese"

tbl_summary(df_outcomes, by = maternal_study_groups, missing="no")


```
### __Study Groups and Problems Combined__
```{r, echo=FALSE, message=FALSE}
df_obesity <- cbind(df_problems_trimmed, maternal_study_groups = df_outcomes$maternal_study_groups)

tbl_summary(df_obesity, by = maternal_study_groups, missing="no")


```

## __ICD 10 Codes__

#### __ICD 10 Codes Corresponding to Bleeding__
<table>
<caption><span id="tab:table2"></span></caption>

Column 1       Column 2
-------------  ---------
O26.851       	Spotting complicating pregnancy, first trimester
O26.852       	Spotting complicating pregnancy, second trimester
O26.853       	Spotting complicating pregnancy, third trimester
O26.859       	Spotting complicating pregnancy, unspecified trimester
</table>

#### __ICD 10 Codes Corresponding to UTI__
<table>
<caption><span id="tab:table2"></span></caption>

Column 1       Column 2
-------------  ---------
O23.31        	Infections of other parts of urinary tract in pregnancy, first trimester	
O23.32        	Infections of other parts of urinary tract in pregnancy, second trimester	
O23.33        	Infections of other parts of urinary tract in pregnancy, third trimester	
O23.30        	Infections of other parts of urinary tract in pregnancy, unspecified trimester	
O23.21        	Infections of urethra in pregnancy, first trimester	
O23.22        	Infections of urethra in pregnancy, second trimester	
O23.23        	Infections of urethra in pregnancy, third trimester	
O23.20        	Infections of urethra in pregnancy, unspecified trimester	
</table>

#### __ICD 10 Codes Corresponding to Nausea__
<table>
<caption><span id="tab:table2"></span></caption>

Column 1       Column 2
-------------  ---------
O21.0       	Mild hyperemesis gravidarum
O21.1       	Hyperemesis gravidarum with metabolic disturbance
O21.2       	Late vomiting of pregnancy
O21.8       	Other vomiting complicating pregnancy
O21.9       	Vomiting of pregnancy, unspecified
</table>


##### __ICD 10 Codes Corresponding to High Blood Pressure__
<table>
<caption><span id="tab:table2"></span></caption>

Column 1       Column 2
-------------  ---------
O13.1       	Gestational [pregnancy-induced] hypertension without significant proteinuria, first trimester
O13.2       	Gestational [pregnancy-induced] hypertension without significant proteinuria, second trimester
O13.3	        Gestational [pregnancy-induced] hypertension without significant proteinuria, third trimester
O13.4	        Gestational [pregnancy-induced] hypertension without significant proteinuria, complicating childbirth
O13.5	        Gestational [pregnancy-induced] hypertension without significant proteinuria, complicating the puerperium
O13.9	        Gestational [pregnancy-induced] hypertension without significant proteinuria, unspecified trimester
O14.00	        Mild to moderate pre-eclampsia, unspecified trimester
O14.02	        Mild to moderate pre-eclampsia, second trimester
O14.03	        Mild to moderate pre-eclampsia, third trimester
O14.04	        Mild to moderate pre-eclampsia, complicating childbirth
O14.05	        Mild to moderate pre-eclampsia, complicating the puerperium
O14.10	        Severe pre-eclampsia, unspecified trimester
O14.12	        Severe pre-eclampsia, second trimester
O14.13	        Severe pre-eclampsia, third trimester
O14.14	        Severe pre-eclampsia complicating childbirth
O14.15	        Severe pre-eclampsia, complicating the puerperium
O14.90	        Unspecified pre-eclampsia, unspecified trimester
O14.92	        Unspecified pre-eclampsia, second trimester
O14.93	        Unspecified pre-eclampsia, third trimester
O14.94        	Unspecified pre-eclampsia, complicating childbirth
O14.95        z	Unspecified pre-eclampsia, complicating the puerperium
</table>

##### __ICD 10 Codes Corresponding to High Blood Pressure__
<table>
<caption><span id="tab:table2"></span></caption>
Column 1       Column 2
-------------  ---------
O43.891	Other placental disorders, first trimester
O43.892	Other placental disorders, second trimester
O43.893	Other placental disorders, third trimester
O43.899	Other placental disorders, unspecified trimester
O43.90	Unspecified placental disorder, unspecified trimester
O43.92	Unspecified placental disorder, second trimester
O43.93	Unspecified placental disorder, third trimester
O44.00	Complete placenta previa NOS or without hemorrhage, unspecified trimester
O44.01	Complete placenta previa NOS or without hemorrhage, first trimester
O44.02	Complete placenta previa NOS or without hemorrhage, second trimester
O44.03	Complete placenta previa NOS or without hemorrhage, third trimester
O44.10	Complete placenta previa with hemorrhage, unspecified trimester
O44.11	Complete placenta previa with hemorrhage, first trimester
O44.12	Complete placenta previa with hemorrhage, second trimester
O44.13	Complete placenta previa with hemorrhage, third trimester
O44.20	Partial placenta previa NOS or without hemorrhage, unspecified trimester
O44.21	Partial placenta previa NOS or without hemorrhage, first trimester
O44.22	Partial placenta previa NOS or without hemorrhage, second trimester
O44.23	Partial placenta previa NOS or without hemorrhage, third trimester
O44.30	Partial placenta previa with hemorrhage, unspecified trimester
O44.32	Partial placenta previa with hemorrhage, second trimester
O44.33	Partial placenta previa with hemorrhage, third trimester
O45.002	Premature separation of placenta with coagulation defect, unspecified, second trimester
O45.003	Premature separation of placenta with coagulation defect, unspecified, third trimester
O45.009	Premature separation of placenta with coagulation defect, unspecified, unspecified trimester
O45.013	Premature separation of placenta with afibrinogenemia, third trimester
O45.023	Premature separation of placenta with disseminated intravascular coagulation, third trimester
O45.092	Premature separation of placenta with other coagulation defect, second trimester
O45.093	Premature separation of placenta with other coagulation defect, third trimester
O45.8X2	Other premature separation of placenta, second trimester
O45.8X3	Other premature separation of placenta, third trimester
O45.8X9	Other premature separation of placenta, unspecified trimester
O45.90	Premature separation of placenta, unspecified, unspecified trimester
O45.91	Premature separation of placenta, unspecified, first trimester
O45.92	Premature separation of placenta, unspecified, second trimester
O45.93	Premature separation of placenta, unspecified, third trimester
</table>

##### __ICD 10 Codes Corresponding to Water Broke Early/Premature Rupture of Membranes__
<table>
<caption><span id="tab:table2"></span></caption>
Column 1       Column 2
-------------  ---------
O42.00	Premature rupture of membranes, onset of labor within 24 hours of rupture, unspecified weeks of gestation
O42.011	Preterm premature rupture of membranes, onset of labor within 24 hours of rupture, first trimester
O42.012	Preterm premature rupture of membranes, onset of labor within 24 hours of rupture, second trimester
O42.013	Preterm premature rupture of membranes, onset of labor within 24 hours of rupture, third trimester
O42.019	Preterm premature rupture of membranes, onset of labor within 24 hours of rupture, unspecified trimester
O42.02	Full-term premature rupture of membranes, onset of labor within 24 hours of rupture
O42.10	Premature rupture of membranes, onset of labor more than 24 hours following rupture, unspecified weeks of gestation
O42.111	Preterm premature rupture of membranes, onset of labor more than 24 hours following rupture, first trimester
O42.112	Preterm premature rupture of membranes, onset of labor more than 24 hours following rupture, second trimester
O42.113	Preterm premature rupture of membranes, onset of labor more than 24 hours following rupture, third trimester
O42.119	Preterm premature rupture of membranes, onset of labor more than 24 hours following rupture, unspecified trimester
O42.12	Full-term premature rupture of membranes, onset of labor more than 24 hours following rupture
O42.90	Premature rupture of membranes, unspecified as to length of time between rupture and onset of labor, unspecified weeks of gestation
O42.911	Preterm premature rupture of membranes, unspecified as to length of time between rupture and onset of labor, first trimester
O42.912	Preterm premature rupture of membranes, unspecified as to length of time between rupture and onset of labor, second trimester
O42.913	Preterm premature rupture of membranes, unspecified as to length of time between rupture and onset of labor, third trimester
O42.919	Preterm premature rupture of membranes, unspecified as to length of time between rupture and onset of labor, unspecified trimester
O42.92	Full-term premature rupture of membranes, unspecified as to length of time between rupture and onset of labor
</table>
